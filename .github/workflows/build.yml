name: Build Debian GNOME ISO

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-iso:
    runs-on: ubuntu-latest
    env:
      ISO_NAME: custom-debian-gnome.iso
      CHROOT_DIR: rootfs

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap \
            qemu-user-static \
            xorriso \
            grub-pc-bin \
            grub-efi-amd64-bin \
            squashfs-tools \
            mtools \
            rsync \
            syslinux-utils \
            isolinux \
            squashfs-tools

      - name: Create minimal Debian chroot
        run: |
          sudo mkdir -p $CHROOT_DIR
          sudo debootstrap --arch=amd64 bookworm $CHROOT_DIR http://deb.debian.org/debian/

      - name: Mount /proc, /sys, /dev
        run: |
          sudo mount --bind /proc $CHROOT_DIR/proc
          sudo mount --bind /sys $CHROOT_DIR/sys
          sudo mount --bind /dev $CHROOT_DIR/dev

      - name: Install GNOME and utilities inside chroot
        run: |
          sudo chroot $CHROOT_DIR /bin/bash -c "\
            apt-get update && \
            apt-get install -y task-gnome-desktop sudo vim curl net-tools && \
            apt-get clean"

      - name: Unmount /proc, /sys, /dev
        run: |
          sudo umount $CHROOT_DIR/proc
          sudo umount $CHROOT_DIR/sys
          sudo umount $CHROOT_DIR/dev

      - name: Prepare ISO structure
        run: |
          mkdir -p iso/{boot/grub,live}
          rsync -a $CHROOT_DIR/ iso/live/
          grub-mkrescue -o $ISO_NAME iso

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: $ISO_NAME
          path: $ISO_NAME
