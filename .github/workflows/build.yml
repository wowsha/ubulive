name: Build Debian GNOME ISO

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-iso:
    runs-on: ubuntu-latest
    env:
      ISO_NAME: custom-debian-gnome.iso
      CHROOT_DIR: rootfs
      ISO_DIR: iso

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap \
            xorriso \
            grub-pc-bin \
            grub-efi-amd64-bin \
            squashfs-tools \
            mtools \
            rsync \
            sudo \
            tasksel \
            isolinux \
            syslinux-utils \
            curl \
            vim \
            qemu-user-static \
            fakeroot

      - name: Create minimal Debian chroot
        run: |
          sudo mkdir -p $CHROOT_DIR
          sudo debootstrap --arch=amd64 bookworm $CHROOT_DIR http://deb.debian.org/debian/

      - name: Mount /proc, /sys, /dev
        run: |
          sudo mount --bind /proc $CHROOT_DIR/proc
          sudo mount --bind /sys $CHROOT_DIR/sys
          sudo mount --bind /dev $CHROOT_DIR/dev

      - name: Install GNOME desktop inside chroot
        run: |
          sudo chroot $CHROOT_DIR /bin/bash -c "\
            apt-get update && \
            DEBIAN_FRONTEND=noninteractive apt-get install -y \
              task-gnome-desktop sudo vim curl net-tools && \
            apt-get clean"

      - name: Unmount /proc, /sys, /dev
        run: |
          sudo umount $CHROOT_DIR/proc
          sudo umount $CHROOT_DIR/sys
          sudo umount $CHROOT_DIR/dev

      - name: Prepare ISO structure
        run: |
          mkdir -p $ISO_DIR/{boot/grub,live}
          # Copy chroot contents to ISO live folder, excluding virtual filesystems
          sudo rsync -a --exclude=/dev --exclude=/proc --exclude=/sys --exclude=/run --exclude=/tmp $CHROOT_DIR/ $ISO_DIR/live/
          # Build ISO into workspace
          sudo grub-mkrescue -o "$GITHUB_WORKSPACE/$ISO_NAME" "$ISO_DIR" --target=i386-pc

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: $ISO_NAME
          path: "$GITHUB_WORKSPACE/$ISO_NAME"
